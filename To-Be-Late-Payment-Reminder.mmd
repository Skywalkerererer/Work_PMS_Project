flowchart TB
classDef event fill:#fff,stroke:#333,stroke-width:1px;
classDef task fill:#dfefff,stroke:#4a76b8,stroke-width:1px;
classDef decision fill:#fff9c4,stroke:#b59a00,stroke-width:1px;
classDef offsys fill:#f6f6f6,stroke:#888,stroke-dasharray: 3 3;

subgraph TENANT["Tenant / Occupant"]
  T_notice((Receives notice)):::event
  T_pay[Pay: FPS/Autopay/Bank/Cheque]:::task
  T_dispute[Raise dispute / query]:::task
end

subgraph PMS["PMS - Billing & Dunning Engine"]
  P_sched[Daily scheduler: identify overdue invoices]:::task
  P_excl{Excluded? dispute, payment plan, hold}:::decision
  P_level[Compute dunning level and days past due]:::task
  P_fee[Apply late fee/interest if crossing threshold]:::task
  P_action[Create dunning action + case]:::task
  P_log[Log comms & audit trail]:::task
end

subgraph NOTIFY["Comms Service (Email/SMS/Letter)"]
  N_send[Send notice per template & language]:::task
  N_bounce{Bounce or delivery failure?}:::decision
  N_call[Queue outbound call task]:::task
end

subgraph AR["AR / Collections"]
  A_queue[Review dunning queue]:::task
  A_pay{Payment received?}:::decision
  A_alloc[Allocate receipt and clear case]:::task
  A_partial{Partial or short-payment?}:::decision
  A_plan[Offer payment plan; capture terms]:::task
  A_dispute[Mark as dispute; suspend dunning]:::task
end

subgraph PMGR["Property Manager"]
  M_invest[Investigate dispute]:::task
  M_valid{Dispute valid?}:::decision
  M_adjust[Adjust charge / issue credit note]:::task
  M_reject[Reject dispute; resume dunning]:::task
end

subgraph FINLEGAL["Finance / Legal Escalation"]
  F_escalate{Age > 45d or Amt > threshold?}:::decision
  F_final[Final notice; service hold request]:::task
  F_legal{Age > 60d or >HKD X?}:::decision
  F_referral[Refer to legal / DCA]:::task
end

%% Main flow
P_sched-->P_excl
P_excl--"Yes"-->P_log-->P_sched
P_excl--"No"-->P_level-->P_fee-->P_action-->N_send
N_send-->N_bounce
N_bounce--"Yes"-->N_call-->A_queue
N_bounce--"No"-->A_queue

%% Customer reactions
T_notice-->T_pay-->A_queue
T_notice-->T_dispute-->A_dispute-->M_invest

%% AR handling
A_queue-->A_pay
A_pay--"Yes (Full)"-->A_alloc-->P_log
A_pay--"Yes (Partial)"-->A_partial
A_partial--"Offer accepted"-->A_plan-->P_log
A_partial--"Declined"-->F_escalate
A_pay--"No"-->F_escalate

%% Dispute handling
M_invest-->M_valid
M_valid--"Yes"-->M_adjust-->P_log
M_valid--"No"-->M_reject-->P_log

%% Escalations
F_escalate--"No"-->P_sched
F_escalate--"Yes"-->F_final-->F_legal
F_legal--"Yes"-->F_referral-->P_log
F_legal--"No"-->P_log

%% Loop
P_log-->P_sched
